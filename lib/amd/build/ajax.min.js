define(["jquery","core/config","core/log","core/url"],function(a,b,c,d){var e=!1,f=function(a){var b,c,e=this,f=null,g=0;if(a.error)for(;g<e.length;g++)b=e[g],b.deferred.reject(a);else{for(g=0;g<e.length;g++){if(b=e[g],c=a[g],"undefined"==typeof c){f=new Error("missing response");break}if(c.error!==!1){f=c.exception;break}b.deferred.resolve(c.data)}null!==f&&("servicerequireslogin"===f.errorcode?window.location=d.relativeUrl("/login/index.php"):e.forEach(function(a){a.deferred.reject(f)}))}},g=function(a,b,d){var f=this,g=0;for(g=0;g<f.length;g++){var h=f[g];e?(c.error("Page unloaded."),c.error(d)):h.deferred.reject(d)}};return{call:function(c,d,h,i,j,k){a(window).bind("beforeunload",function(){e=!0});var l,m=[],n=[],o=[],p="",q=2e3;for("undefined"==typeof h&&(h=!0),"undefined"==typeof d&&(d=!0),"undefined"==typeof j&&(j=0),"undefined"==typeof k?k=null:(k=parseInt(k),k<=0?k=null:k||(k=null)),"undefined"==typeof i&&(i=!1),l=0;l<c.length;l++){var r=c[l];m.push({index:l,methodname:r.methodname,args:r.args}),r.deferred=a.Deferred(),n.push(r.deferred.promise()),"undefined"!=typeof r.done&&r.deferred.done(r.done),"undefined"!=typeof r.fail&&r.deferred.fail(r.fail),r.index=l,o.push(r.methodname)}p=o.length<=5?o.sort().join():o.length+"-method-calls",m=JSON.stringify(m);var s={type:"POST",context:c,dataType:"json",processData:!1,async:d,contentType:"application/json"},t="service.php",u=b.wwwroot+"/lib/ajax/";if(h?u+=t+"?sesskey="+b.sesskey+"&info="+p:(t="service-nologin.php",u+=t+"?info="+p,k&&(u+="&cachekey="+k,s.type="GET")),i&&(u+="&nosessionupdate=true"),"POST"===s.type)s.data=m;else{var v=u+"&args="+encodeURIComponent(m);v.length>q?(s.type="POST",s.data=m):u=v}return d?a.ajax(u,s).done(f).fail(g):(s.success=f,s.error=g,a.ajax(u,s)),n}}});